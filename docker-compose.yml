version: '2'
services:
    nginx:
        image: tutum/nginx
        ports:
          - "80:80"
        volumes:
          - ./docker/nginx/default:/etc/nginx/conf.d/default.conf

          - ./docker/nginx/logs/nginx-error.log:/var/log/nginx/error.log
          - ./docker/nginx/logs/nginx-access.log:/var/log/nginx/access.log

    phpfpm:
        build:
            context: ./
            dockerfile: ./docker/php-fpm/phpfpm.docker
        links:
          - mysql:mysql
          - postgresql:postgresql
        ports:
          - "9001:9000"
        volumes:
          - ./:/var/www/website
    mysql:
        image: mariadb
        environment:
          MYSQL_TCP_PORT: 3306
          MYSQL_ROOT_PASSWORD: root

    phpmyadmin:
        image: phpmyadmin/phpmyadmin
        restart: always
        depends_on:
          - mysql
        links:
            - mysql:mysql
        ports:
            - 8183:80
        environment:
          PMA_HOST: mysql
          PMA_PORT: 3306
          MYSQL_ROOT_PASSWORD: root
    postgresql:
        image: postgres
        volumes:
            - ./docker/postgres/data:/var/lib/postgresql/data
            - ./docker/postgres/logs:/var/log/postgresql
        ports:
            - "5432:5432"
        environment:
            - POSTGRES_PASSWORD=root
            - POSTGRES_USER=root
            - POSTGRES_DB=own.lemp.docker
            - PGDATA=/var/lib/postgresql/data/pgdata
  # MongoDB: https://hub.docker.com/_/mongo/
    mongo:
      image: mongo:3
      volumes:
        - mongo_data:/data/db
    # Elasticsearch: https://www.elastic.co/guide/en/elasticsearch/reference/5.5/docker.html
    elasticsearch:
      image: docker.elastic.co/elasticsearch/elasticsearch:5.6.12
      volumes:
        - es_data:/usr/share/elasticsearch/data
      environment:
        - http.host=0.0.0.0
        - transport.host=localhost
        - network.host=0.0.0.0
        # Disable X-Pack security: https://www.elastic.co/guide/en/elasticsearch/reference/5.5/security-settings.html#general-security-settings
        - xpack.security.enabled=false
        - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      ulimits:
        memlock:
          soft: -1
          hard: -1
      mem_limit: 1g
    # Graylog: https://hub.docker.com/r/graylog/graylog/
    graylog:
      image: graylog/graylog:2.4
      volumes:
        - ./docker/graylog/logs:/usr/share/graylog/data/journal
        - ./docker/graylog/config:/usr/share/graylog/data/config
      environment:
        # CHANGE ME!
        - GRAYLOG_PASSWORD_SECRET=root
        # Password: admin
        - GRAYLOG_ROOT_PASSWORD_SHA2=8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918
        - GRAYLOG_WEB_ENDPOINT_URI=http://172.17.0.1:9000/api
      links:
        - mongo
        - elasticsearch
      ports:
        # Graylog web interface and REST API
        - 9000:9000
        # Syslog TCP
        - 514:514
        # Syslog UDP
        - 514:514/udp
        # GELF TCP
        - 12201:12201
        # GELF UDP
        - 12201:12201/udp

    # Volumes for persisting data, see https://docs.docker.com/engine/admin/volumes/volumes/
volumes:
  mongo_data:
    driver: local
  es_data:
    driver: local
  graylog_journal:
    driver: local